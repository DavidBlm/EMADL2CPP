package instanceTestUnroll;

component RNNencdec{
    ports in Z(0:49999)^{50} source,
         out Z(0:49999)^{1} target[50];

    implementation CNN{
        layer GRU(units=10) encoder;

        source ->
        Embedding(output_dim=10) ->
        encoder;

        1 -> target[0];

        layer GRU(units=10) decoder;

        encoder.state -> decoder.state;

        timed<t> GreedySearch(max_length=50) {
            (
                (
                    target[t-1] ->
                    Embedding(output_dim=10) ->
                    Repeat(n=91, axis=1)
                |
                    fc.output
                ) ->
                Concatenate(dim=2) ->
                FullyConnected(units=10, flatten=false) ->
                Tanh() ->
                FullyConnected(units=91, flatten=false) ->
                FullyConnected(units=1, flatten=false)
            |
                encoder.output ->
                FullyConnected(units=1, flatten=false) ->
                SwapAxes(axes=(1,2))
            ) ->
            Dot() ->
            decoder ->
            FullyConnected(units=50000) ->
            Softmax() ->
            ArgMax() ->
            target[t]
        };
     }
 }
