package instanceTestUnroll;

component RNNencdec{
   ports in Z(0:29999)^{75} source,
        out Z(0:29999)^{1} target[91];

   implementation CNN{

    layer GRU(units=10, bidirectional=true) encoder;

    source ->
    Embedding(output_dim=10) ->
    encoder;

    layer FullyConnected(units=10, flatten=false) fc;
    encoder.output ->
    fc;

    1 -> target[0];

    layer GRU(units=10) decoder;

    encoder.state -> Split(n=2) -> Get(index=1) -> decoder.state;

    timed<t> GreedySearch(max_length=91) {
        (
            (
                (
                    decoder.state ->
                    Repeat(n=91, axis=1)
                |
                    fc.output
                ) ->
                Concatenate(dim=2) ->
                FullyConnected(units=10, flatten=false) ->
                Tanh() ->
                FullyConnected(units=91) ->
                Softmax()
            |
                fc.output
            ) ->
            Dot()
        |
            target[t-1] ->
            Embedding(output_dim=10)
        ) ->
        Concatenate() ->
        decoder ->
        FullyConnected(units=30000) ->
        Softmax() ->
        ArgMax() ->
        target[t]
    };
 }
 }
